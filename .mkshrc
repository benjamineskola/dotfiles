# vim:ft=sh

if [ -z "$TMUX" ]; then
	pgrep tmux || tmux start-server
	tmux ls|grep "^$TERM"|grep -v attached|cut -d: -f1|xargs -n1 -r tmux kill-session -t
	exec tmux -2 new-session -s $TERM-$(date +%s)-$$
fi

. ~/.environment

# define useful aliases for ls based on which *nix we're on.
case $OSTYPE in
	Linux)
		alias ls='ls --color=auto -Fh' ;;
	FreeBSD|Darwin)
		alias ls='ls -GhTp' ;;
	*)
		alias ls='ls -Fh' ;;
esac

# and some generic ones.
alias ll='ls -l'
alias la='ls -A'
alias lal='ls -lA'
alias lsd='ls -d'

alias rem='rem -qg'
alias w3m='w3m -F -v'

alias grep='egrep'
alias feh="feh -FZ"

alias df="df -P"
alias tf="tail -F"

alias apg="apg -a 1 -n 1 -c /dev/urandom"
alias rename=$(which rename) # mksh has a builtin 'rename'; alias will override builtin
alias pt="pstree -auUlp"

rem(){(cd ~; $(which rem) $@)}
alias remcal='rem -cuc -w$COLUMNS'

case $OSTYPE in
	Linux)
		if [[ -e /etc/debian_version ]]; then
			alias ack="ack-grep -a"

			alias acs="apt-cache search"
			alias acsh="apt-cache show"
			alias acsno="apt-cache search -n"
			alias sagi="sudo apt-get install --no-install-recommends"
			alias sagir="sudo apt-get install"
			alias sagr="sudo apt-get purge"
			alias sagu="sudo apt-get update"
			alias sagup="sudo apt-get upgrade"

			eval `lesspipe`
		else
			alias ack="ack -a"
		fi
		[[ -x `which bsdtar` ]] && alias tar=bsdtar && alias unzip="tar xf"
		;;
	FreeBSD)
		eval `lesspipe.sh`
		alias unzip="tar xf"
		;;
esac

PS1="\$(whoami)@${HOSTNAME}:\$(test \"\$PWD\" = \$HOME && echo '~' || basename \"\${PWD}\")"
PS1INIT="$(print \\001)"
PS1INIT="$PS1INIT$(print \\r)$PS1INIT"
ESC=$(print \\033)
BEL=$(print \\007)
case $TERM in
	xterm*|rxvt*|screen*)
		PS1="${PS1INIT}${ESC}]0;${PS1}${BEL}${ESC}[0;01;1m${PS1}> ${ESC}[0m"
	;;
	*)
		PS1="${PS1INIT}${ESC}[0;01;1m${PS1}> ${ESC}[0m"
	;;
esac

if [[ `whoami` != root ]]; then
	if [[ -x `which keychain` ]]; then
		eval `keychain --eval -q --dir $XDG_CACHE_HOME/keychain`
		ssh-add -l > /dev/null || ssh-add
	fi
fi

HISTFILE=$XDG_CACHE_HOME/ksh_history
HISTSIZE=819200
SAVEHIST=819200

stty stop undef
ulimit -c 0

bindkey -e 2>/dev/null || true # ksh might be zsh which is braindead and assumes i want vi keybindings.

mkdir -p ${XDG_CACHE_HOME}

. ${XDG_CONFIG_HOME}/mksh/dirs.ksh
